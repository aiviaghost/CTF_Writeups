from enigma.machine import EnigmaMachine # https://py-enigma.readthedocs.io/en/latest/overview.html
from itertools import product
from string import ascii_uppercase


with open("wehrmacht.txt", "r") as f:
    ciphertext = ''.join(f.readlines()).replace("\n", "").replace(" ", "")

machine = EnigmaMachine.from_key_sheet(
       rotors='I II III',
       reflector='B',
       ring_settings=[1, 2, 3],
       plugboard_settings='AQ BJ')

for p in product(ascii_uppercase, ascii_uppercase, ascii_uppercase):
    # print(''.join(p))
    machine.set_display(''.join(p))
    plaintext = machine.process_text(ciphertext)
    if "ICECTF" in plaintext:
        print("Starting positions: " + ''.join(p))
        print(plaintext)
        break

'''
deciphered: 
ICECTFTURINGMACHFAWGHADEOACZYYPRPXGXFZHKYKTICHOSENISKNOWNASQWERTZUORQERXTHEDIAGRAMSHOWSTHECONNXCTIONSWHENTHEKEYQISDEPRESYEDANDSUPPOSINGTHATCISCONNLCTEDTOCTHROUGHTHEWHEELSXTQEONLYOUTLETFORTHEPOSITIVEYFTHEBATTERYISTHROUGHTHEQKFYTOGHENCETOCANDTHENTHROUGFTHEEBULBXTHERESULTISTHATTWEEBULBLIGHTSXMOREGENERALLOWECANSAYIFTWOCONTACTSCZZDMFTHEEINTRITTSWALZARECONNEUTEDTHROUGHTHEWHEELSTHENTHORESULTOFENCIPHERINGTHELETNERASSOCIATEDWITHCISTHELETTERASSOCIATEDWITHDXNOTICETIATIFPISTHERESULTOFENCIPHEHINGGZZTHENGISTHERESULTOFEYCIPHERINGPATTHESAMEPLACEZIALSOTHATTHERESULTOFENCIPHHRINGGCANNEVERBEGXONTHEWHELLSARERINGSORTYRESCARRYINGKLPHABETSZZANDROTATABLEWITPRESPECTTOTHERESTOFTHEWHEEHQRRJMFPKQTHGYZMBWLCJTGZMBNWXWHENTHEMACHINEISBEINGUSXDTHREEOFTHEWHEELSAREPUTINUETWEENTHEUXKXWXANDTHEEXWXUNSOMEPRESCRIBEDORDERXTHEWPYTHATTHECURRENTMIGHTFLOWFJOMTHEEXWXTHROUGHTHEWHEELSKNDBACKISSHOWNBELOWXVERYNIJEWORKXTHECODEISICECTFTURIYGMACHINEX

Flag: ICECTF{TURINGMACHINE}
'''
